<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="format-detection" content="telephone=no, email=no, address=no"/>
<title>å‘¨æœŸæ—¥å†</title>
<style>
:root{
  --bg:#0b0d10;--card:#11151a;--muted:#8ea0b4;--text:#e9eef5;
  --accent:#6ea8fe;--accent2:#ff99c8;--danger:#ff6b6b;--ok:#21c98a;
  --border:#1b222b;--border-soft:#1f2a37;--shadow:0 10px 24px rgba(0,0,0,.3);
}
@media(prefers-color-scheme:light){
  :root{
    --bg:#f5f7fa;--card:#fff;--muted:#6b7a8a;--text:#10131a;
    --accent:#4c83ff;--accent2:#ff7fb5;--danger:#ff5f74;--ok:#1fb47c;
    --border:#e6eaf0;--border-soft:#e9eef5;--shadow:0 8px 20px rgba(0,0,0,.06);
  }
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;min-height:100svh;background:var(--bg);color:var(--text);
  font:12px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.topbar{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.brand{font-weight:800;color:var(--accent);font-size:14px}
.grid{display:grid;gap:12px;grid-template-columns:380px 1fr}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
.section-head{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--border);font-size:13px}
.section-head h2{margin:0;font-size:13px;color:var(--accent)}
.inner{padding:12px}
label{display:block;margin:6px 0 4px;font-size:12px;font-weight:600}
input,textarea,select{width:100%;padding:8px;border:1px solid var(--border-soft);border-radius:8px;background:#0c1116;color:var(--text);font-size:12px}
textarea{resize:vertical;min-height:48px}
button{cursor:pointer;padding:8px 12px;font-size:12px;border-radius:8px;font-weight:600}
button{border:1px solid var(--accent);background:linear-gradient(90deg,var(--accent),#8fd0ff);color:#00132b}
button.ghost{background:transparent;color:var(--accent)}
button.min{padding:4px 8px;font-size:11px}
.muted{color:var(--muted)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cell{aspect-ratio:1/1;border:1px solid var(--border);border-radius:6px;padding:2px;position:relative;font-size:10px}
.cell.today{outline:2px solid var(--accent)}
.cell .d{position:absolute;top:2px;right:4px;font-size:11px;color:var(--muted)}
.badges{position:absolute;left:4px;bottom:4px;display:flex;gap:4px;font-size:12px}
.badges span{font-size:12px}
.legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;font-size:11px}
.legend .tag{display:flex;align-items:center;gap:4px;padding:4px 6px;border-radius:999px;border:1px solid var(--border)}
.kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.kpi .item{padding:8px;border:1px solid var(--border);border-radius:8px}
.kpi .item b{color:var(--accent);font-size:13px}
table{width:100%;border-collapse:collapse;font-size:11px}
th,td{padding:6px 4px;border-bottom:1px solid var(--border)}
th{color:var(--muted);font-weight:700;background:var(--card);position:sticky;top:0}
td.actions{white-space:nowrap}
.toast{position:fixed;left:50%;bottom:max(12px,env(safe-area-inset-bottom));transform:translateX(-50%);background:var(--card);border:1px solid var(--border);padding:6px 8px;border-radius:8px;display:none;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">å‘¨æœŸæ—¥å†</div>
  </div>
  <div class="grid">
    <!-- å·¦ä¾§ï¼šè¡¨å• -->
    <section class="card">
      <div class="section-head"><h2>è®°å½•ä¸­å¿ƒ</h2></div>
      <div class="inner">
        <label>å§¨å¦ˆ</label>
        <input id="pStart" type="date"><input id="pEnd" type="date" style="margin-top:4px">
        <button id="btnAddPeriod" style="margin-top:6px">æ·»åŠ å§¨å¦ˆ</button>
        <button id="btnQuickPeriod" class="ghost min">ä»Šå¤©</button>
        <label style="margin-top:6px">èº«ä½“å˜åŒ–</label>
        <input id="bDate" type="date"><textarea id="bNote"></textarea>
        <button id="btnAddBody" style="margin-top:6px">æ·»åŠ å˜åŒ–</button>
        <label style="margin-top:6px">å…³ç³»</label>
        <input id="sDate" type="date">
        <button id="btnAddSex" style="margin-top:6px">æ·»åŠ å…³ç³»</button>
      </div>
      <div class="section-head"><h2>ç»Ÿè®¡ä¸æ•°æ®</h2></div>
      <div class="inner">
        <div class="kpi">
          <div class="item"><div class="muted">è®°å½•å‘¨æœŸæ•°</div><b id="kCycles">0</b></div>
          <div class="item"><div class="muted">å¹³å‡å‘¨æœŸ</div><b id="kAvg">â€”</b></div>
          <div class="item"><div class="muted">ä¸‹æ¬¡æœˆç»</div><b id="kNext">â€”</b></div>
          <div class="item"><div class="muted">æ˜“å­•æœŸ</div><b id="kFertile">â€”</b></div>
        </div>
        <div style="margin-top:6px">
          <button id="btnExport" class="ghost min">å¯¼å‡º</button>
          <input type="file" id="fileImport" accept="application/json" style="display:none"/>
          <button id="btnImport" class="ghost min">å¯¼å…¥</button>
          <button id="btnResetSamples" class="ghost min">æ¢å¤ç¤ºä¾‹</button>
          <button id="btnClearAll" class="ghost min">æ¸…ç©º</button>
        </div>
      </div>
    </section>
    <!-- å³ä¾§ï¼šæ—¥å† + å†å² -->
    <section class="card cal">
      <div class="section-head"><h2 id="calTitle">æ—¥å†</h2>
        <div><button id="prevM" class="ghost min">ä¸Šæœˆ</button><button id="todayM" class="ghost min">ä»Šå¤©</button><button id="nextM" class="ghost min">ä¸‹æœˆ</button></div>
      </div>
      <div class="inner">
        <div class="cal-grid" id="dow"></div>
        <div class="cal-grid" id="cal"></div>
     <div class="legend muted">
  <span class="tag" style="background:#d8a7a7;color:#fff;">ç»</span>
  <span class="tag" style="background:#c8d8b7;color:#333;">å­•</span>
  <span class="tag" style="background:#b7cdd8;color:#333;">æ’</span>
  <span class="tag" style="background:#d7c2b7;color:#333;">é»„</span>
  <span class="tag" style="color:#b98ca0;">ğŸ’—</span>
  <span class="tag" style="color:#a8b9c7;">â„¹ï¸</span>
</div>

        <div style="margin-top:6px">
          <label><input type="checkbox" id="fltM" checked>å§¨å¦ˆ</label>
          <label><input type="checkbox" id="fltF" checked>æ˜“å­•</label>
          <label><input type="checkbox" id="fltO" checked>æ’åµ</label>
          <label><input type="checkbox" id="fltL" checked>é»„ä½“</label>
          <label><input type="checkbox" id="fltSX" checked>å…³ç³»</label>
          <label><input type="checkbox" id="fltBN" checked>å˜åŒ–</label>
        </div>
      </div>
      <div class="section-head"><h2>å†å²ä¸ç¼–è¾‘</h2></div>
      <div class="inner">
        <input id="search" placeholder="æœç´¢å¤‡æ³¨æˆ–æ—¥æœŸ">
        <h3>å§¨å¦ˆå†å²</h3><table id="tblPeriod"><thead><tr><th>å¼€å§‹</th><th>ç»“æŸ</th><th>ç»æœŸ</th><th>å‘¨æœŸ</th><th class="actions">æ“ä½œ</th></tr></thead><tbody></tbody></table>
        <h3>èº«ä½“å˜åŒ–</h3><table id="tblBody"><thead><tr><th>æ—¥æœŸ</th><th>å¤‡æ³¨</th><th class="actions">æ“ä½œ</th></tr></thead><tbody></tbody></table>
        <h3>å…³ç³»å†å²</h3><table id="tblSex"><thead><tr><th>æ—¥æœŸ</th><th class="actions">æ“ä½œ</th></tr></thead><tbody></tbody></table>
      </div>
    </section>
  </div>
</div>
<div id="toast" class="toast"></div>
<script>
/* ===== æ•°æ®å­˜å‚¨ ===== */
let periods=JSON.parse(localStorage.getItem("period")||"[]");
let bodies=JSON.parse(localStorage.getItem("body")||"[]");
let sexes=JSON.parse(localStorage.getItem("sex")||"[]");
function saveData(){localStorage.setItem("period",JSON.stringify(periods));localStorage.setItem("body",JSON.stringify(bodies));localStorage.setItem("sex",JSON.stringify(sexes));}
function toast(m){let t=document.getElementById("toast");t.textContent=m;t.style.display="block";clearTimeout(t._h);t._h=setTimeout(()=>t.style.display="none",1500);}
const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const parse=s=>{let [y,m,d]=s.split("-").map(Number);return new Date(y,m-1,d,12);};
const add=(d,n)=>{let x=new Date(d);x.setDate(x.getDate()+n);return x;}
const daysBetween=(a,b)=>Math.round((parse(b)-parse(a))/86400000);
const safe=s=>(s||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
/* ===== KPIä¸é¢„æµ‹ ===== */
function getCycleLens(){let arr=[...periods].sort((a,b)=>a.start.localeCompare(b.start)),res=[];for(let i=1;i<arr.length;i++)res.push(daysBetween(arr[i-1].start,arr[i].start));return res;}
function avg(a){return a.length?Math.round(a.reduce((x,y)=>x+y)/a.length):null;}
function getAvgC(){return avg(getCycleLens())}
function getPred(){let last=[...periods].sort((a,b)=>a.start.localeCompare(b.start)).at(-1);if(!last)return{windows:[]};let avgC=getAvgC()||28;let pLen=last.len||5;let next=add(parse(last.start),avgC);let ovu=add(next,-14);let wins=[{from:parse(last.start),to:parse(last.end),type:"ç»"}];wins.push({from:add(ovu,-5),to:add(ovu,1),type:"å­•"});wins.push({from:ovu,to:ovu,type:"æ’"});wins.push({from:add(ovu,2),to:add(next,-1),type:"é»„"});return{next,windows:wins};}
function renderKPIs(){let cyc=getCycleLens();document.getElementById("kCycles").textContent=cyc.length;document.getElementById("kAvg").textContent=getAvgC()?getAvgC()+"å¤©":"â€”";let pred=getPred();document.getElementById("kNext").textContent=pred.next?fmt(pred.next):"â€”";}
/* ===== æ—¥å†æ¸²æŸ“ ===== */
function ensureDow(){let el=document.getElementById("dow");if(el.dataset.ok)return;["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"].forEach(d=>{let x=document.createElement("div");x.textContent=d;x.className="muted";x.style.textAlign="center";el.appendChild(x)});el.dataset.ok=1;}
function renderCalendar(){ensureDow();let cal=document.getElementById("cal");cal.innerHTML="";let view=window.__viewDate||new Date(),cur=new Date(view);cur.setDate(1);let y=cur.getFullYear(),m=cur.getMonth();let start=(cur.getDay()+6)%7,days=new Date(y,m+1,0).getDate();let today=fmt(new Date());let pred=getPred().windows;let bodyMap=new Map();bodies.forEach(b=>bodyMap.set(b.date,(bodyMap.get(b.date)||0)+1));let sexSet=new Set(sexes.map(s=>s.date));
for(let i=0;i<start;i++)cal.appendChild(document.createElement("div"));
for(let d=1;d<=days;d++){let cell=document.createElement("div");cell.className="cell";let dd=new Date(y,m,d,12),ds=fmt(dd);if(ds===today)cell.classList.add("today");let num=document.createElement("div");num.className="d";num.textContent=d;cell.appendChild(num);
let flags=pred.filter(w=>dd>=w.from&&dd<=w.to).map(w=>w.type);if(document.getElementById("fltM").checked && flags.includes("ç»"))
  cell.innerHTML += "<div style='font-size:10px;background:#d8a7a7;color:#fff;padding:1px 3px;border-radius:4px;display:inline-block'>ç»</div>";
if(document.getElementById("fltF").checked && flags.includes("å­•"))
  cell.innerHTML += "<div style='font-size:10px;background:#c8d8b7;color:#333;padding:1px 3px;border-radius:4px;display:inline-block'>å­•</div>";
if(document.getElementById("fltO").checked && flags.includes("æ’"))
  cell.innerHTML += "<div style='font-size:10px;background:#b7cdd8;color:#333;padding:1px 3px;border-radius:4px;display:inline-block'>æ’</div>";
if(document.getElementById("fltL").checked && flags.includes("é»„"))
  cell.innerHTML += "<div style='font-size:10px;background:#d7c2b7;color:#333;padding:1px 3px;border-radius:4px;display:inline-block'>é»„</div>";
let badges=document.createElement("div");badges.className="badges";if(document.getElementById("fltSX").checked&&sexSet.has(ds))badges.innerHTML+="<span style='color:#b98ca0'>ğŸ’—</span>";if(document.getElementById("fltBN").checked&&bodyMap.has(ds))badges.innerHTML+="<span style='color:#a8b9c7'>â„¹ï¸</span>";if(badges.innerHTML)cell.appendChild(badges);cal.appendChild(cell);}}
/* ===== å†å²è¡¨æ ¼ ===== */
function renderTables(f=''){f=f.trim().toLowerCase();let pBody=document.querySelector("#tblPeriod tbody");pBody.innerHTML="";periods.forEach((p,i)=>{if(f && !(p.start.includes(f)||p.end.includes(f)))return;let cyc=i>0?daysBetween(periods[i-1].start,p.start):"â€”";pBody.innerHTML+=`<tr><td>${p.start}</td><td>${p.end}</td><td>${p.len}å¤©</td><td>${cyc}</td><td class="actions"><button data-act="editP" data-i="${i}">ç¼–è¾‘</button><button data-act="delP" data-i="${i}" class="ghost">åˆ é™¤</button></td></tr>`;});if(!pBody.innerHTML)pBody.innerHTML='<tr><td colspan=5 class=muted>æ— </td></tr>';
let bBody=document.querySelector("#tblBody tbody");bBody.innerHTML="";bodies.forEach((b,i)=>{if(f && !(b.date.includes(f)||(b.note||'').toLowerCase().includes(f)))return;bBody.innerHTML+=`<tr><td>${b.date}</td><td>${safe(b.note)}</td><td class="actions"><button data-act="editB" data-i="${i}">ç¼–è¾‘</button><button data-act="delB" data-i="${i}" class="ghost">åˆ é™¤</button></td></tr>`;});if(!bBody.innerHTML)bBody.innerHTML='<tr><td colspan=3 class=muted>æ— </td></tr>';
let sBody=document.querySelector("#tblSex tbody");sBody.innerHTML="";sexes.forEach((s,i)=>{if(f&&!s.date.includes(f))return;sBody.innerHTML+=`<tr><td>${s.date}</td><td class="actions"><button data-act="delS" data-i="${i}" class="ghost">åˆ é™¤</button></td></tr>`;});if(!sBody.innerHTML)sBody.innerHTML='<tr><td colspan=2 class=muted>æ— </td></tr>';}
document.addEventListener("click",(e)=>{let btn=e.target.closest("button[data-act]");if(!btn)return;let act=btn.dataset.act,i=+btn.dataset.i;if(act==="delP"){if(confirm("åˆ é™¤å§¨å¦ˆï¼Ÿ")){periods.splice(i,1);saveData();renderAll();}}if(act==="editP"){let ns=prompt("æ–°å¼€å§‹",periods[i].start);if(!ns)return;let ne=prompt("æ–°ç»“æŸ",periods[i].end);if(!ne)return;periods[i]={start:ns,end:ne,len:daysBetween(ns,ne)+1};saveData();renderAll();}if(act==="delB"){if(confirm("åˆ é™¤å˜åŒ–ï¼Ÿ")){bodies.splice(i,1);saveData();renderAll();}}if(act==="editB"){let nd=prompt("æ—¥æœŸ",bodies[i].date);if(!nd)return;let nn=prompt("å¤‡æ³¨",bodies[i].note);if(nn===null)return;bodies[i]={date:nd,note:nn};saveData();renderAll();}if(act==="delS"){if(confirm("åˆ é™¤å…³ç³»ï¼Ÿ")){sexes.splice(i,1);saveData();renderAll();}}},{passive:true});
/* ===== æ·»åŠ åŠŸèƒ½ ===== */
document.getElementById("btnAddPeriod").onclick=()=>{let s=document.getElementById("pStart").value,e=document.getElementById("pEnd").value;if(!s||!e)return alert("è¯·å¡«å†™");if(parse(e)<parse(s))return alert("ç»“æŸä¸èƒ½æ—©äºå¼€å§‹");periods.push({start:s,end:e,len:daysBetween(s,e)+1});saveData();renderAll();};
document.getElementById("btnQuickPeriod").onclick=()=>{let t=fmt(new Date());periods.push({start:t,end:t,len:1});saveData();renderAll();};
document.getElementById("btnAddBody").onclick=()=>{let d=document.getElementById("bDate").value,n=document.getElementById("bNote").value;if(!d||!n)return alert("è¯·å®Œæ•´");bodies.push({date:d,note:n});saveData();renderAll();};
document.getElementById("btnAddSex").onclick=()=>{let d=document.getElementById("sDate").value;if(!d)return alert("è¯·é€‰æ‹©");sexes.push({date:d});saveData();renderAll();};
/* ===== å¯¼å…¥å¯¼å‡ºæ¸…ç©º ===== */
document.getElementById("btnImport").onclick=()=>document.getElementById("fileImport").click();
document.getElementById("fileImport").addEventListener("change",(e)=>{let f=e.target.files[0];if(!f)return;let r=new FileReader();r.onload=()=>{try{let obj=JSON.parse(r.result);if(obj.period)periods=obj.period;if(obj.body)bodies=obj.body;if(obj.sex)sexes=obj.sex;saveData();renderAll();toast("å¯¼å…¥æˆåŠŸ");}catch(err){alert("å¯¼å…¥å¤±è´¥");}};r.readAsText(f);});
document.getElementById("btnExport").onclick=()=>{let blob=new Blob([JSON.stringify({period:periods,body:bodies,sex:sexes},null,2)],{type:"application/json"});let a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="tracker.json";a.click();toast("å·²å¯¼å‡º");};
document.getElementById("btnResetSamples").onclick=()=>{periods=[{start:"2025-08-03",end:"2025-08-07",len:5},{start:"2025-09-01",end:"2025-09-05",len:5}];bodies=[{date:"2025-09-03",note:"æƒ…ç»ªä½è½"},{date:"2025-09-10",note:"çš®è‚¤å‡ºæ²¹"},{date:"2025-09-18",note:"ä¹³æˆ¿èƒ€ç—›"}];sexes=[{date:"2025-09-10"},{date:"2025-09-18"}];saveData();renderAll();};
document.getElementById("btnClearAll").onclick=()=>{if(confirm("æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ")){periods=[];bodies=[];sexes=[];saveData();renderAll();}};
/* ===== æœç´¢è¿‡æ»¤ ===== */
document.getElementById("search").addEventListener("keydown",(e)=>{if(e.key==="Enter")renderTables(e.target.value);});
/* ===== æœˆä»½åˆ‡æ¢ ===== */
window.__viewDate=new Date();
["prevM","nextM","todayM"].forEach(id=>{document.getElementById(id).onclick=()=>{if(id==="prevM")window.__viewDate.setMonth(window.__viewDate.getMonth()-1);if(id==="nextM")window.__viewDate.setMonth(window.__viewDate.getMonth()+1);if(id==="todayM")window.__viewDate=new Date();renderCalendar();}});
["fltM","fltF","fltO","fltL","fltSX","fltBN"].forEach(id=>document.getElementById(id).onchange=()=>renderCalendar());
/* ===== æ¸²æŸ“èšåˆ ===== */
function renderAll(f=''){renderKPIs();renderCalendar();renderTables(f);}
renderAll();
</script>
</body>
</html>
