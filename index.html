<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="format-detection" content="telephone=no, email=no, address=no"/>
<title>å‘¨æœŸæ—¥å†</title>
<style>
:root{
  --bg:#0b0d10;--card:#11151a;--muted:#8ea0b4;--text:#e9eef5;
  --accent:#6ea8fe;--accent2:#ff99c8;--danger:#ff6b6b;--ok:#21c98a;
  --border:#1b222b;--border-soft:#1f2a37;--shadow:0 8px 20px rgba(0,0,0,.2);
}
@media(prefers-color-scheme:light){
  :root{
    --bg:#f5f7fa;--card:#fff;--muted:#6b7a8a;--text:#10131a;
    --accent:#4c83ff;--accent2:#ff7fb5;--danger:#ff5f74;--ok:#1fb47c;
    --border:#e6eaf0;--border-soft:#e9eef5;--shadow:0 6px 16px rgba(0,0,0,.08);
  }
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;min-height:100svh;background:var(--bg);color:var(--text);
  font:14px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.topbar{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.brand{font-weight:800;color:var(--accent);font-size:16px}
.grid{display:grid;gap:12px;grid-template-columns:380px 1fr}
@media(max-width:768px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
.section-head{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--border);font-size:13px;flex-wrap:wrap}
.section-head h2{margin:0;font-size:14px;color:var(--accent)}
.inner{padding:12px}
label{display:block;margin:6px 0 4px;font-size:12px;font-weight:600}
input,textarea,select{width:100%;padding:8px;border:1px solid var(--border-soft);border-radius:8px;background:#0c1116;color:var(--text);font-size:13px}
textarea{resize:vertical;min-height:48px}
button{cursor:pointer;padding:8px 12px;font-size:13px;border-radius:8px;font-weight:600}
button{border:1px solid var(--accent);background:linear-gradient(90deg,var(--accent),#8fd0ff);color:#00132b}
button.ghost{background:transparent;color:var(--accent)}
button.min{padding:4px 8px;font-size:12px}
.muted{color:var(--muted)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cell{aspect-ratio:1/1;border:1px solid var(--border);border-radius:6px;padding:2px;position:relative;font-size:11px}
.cell.today{outline:2px solid var(--accent)}
.cell .d{position:absolute;top:2px;right:4px;font-size:11px;color:var(--muted)}
.badges{position:absolute;left:4px;bottom:4px;display:flex;gap:4px;font-size:12px}
.legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;font-size:11px}
.legend .tag{display:flex;align-items:center;gap:4px;padding:4px 6px;border-radius:999px;border:1px solid var(--border);cursor:pointer}
.kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.kpi .item{padding:8px;border:1px solid var(--border);border-radius:8px}
.kpi .item b{color:var(--accent);font-size:13px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:6px 4px;border-bottom:1px solid var(--border)}
th{color:var(--muted);font-weight:700;background:var(--card);position:sticky;top:0}
td.actions{white-space:nowrap}
.toast{position:fixed;left:50%;bottom:max(12px,env(safe-area-inset-bottom));transform:translateX(-50%);background:var(--card);border:1px solid var(--border);padding:6px 8px;border-radius:8px;display:none;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">å‘¨æœŸæ—¥å†</div>
  </div>
  <div class="grid">
    <!-- å·¦ä¾§ï¼šè¡¨å• -->
    <section class="card">
      <div class="section-head"><h2>è®°å½•ä¸­å¿ƒ</h2></div>
      <div class="inner">
        <label>å§¨å¦ˆ</label>
        <input id="pStart" type="date"><input id="pEnd" type="date" style="margin-top:4px">
        <button id="btnAddPeriod" style="margin-top:6px">æ·»åŠ å§¨å¦ˆ</button>
        <button id="btnQuickPeriod" class="ghost min">ä»Šå¤©</button>
        <label style="margin-top:6px">èº«ä½“å˜åŒ–</label>
        <input id="bDate" type="date"><textarea id="bNote"></textarea>
        <button id="btnAddBody" style="margin-top:6px">æ·»åŠ å˜åŒ–</button>
        <label style="margin-top:6px">å…³ç³»</label>
        <input id="sDate" type="date">
        <button id="btnAddSex" style="margin-top:6px">æ·»åŠ å…³ç³»</button>
      </div>
      <div class="section-head"><h2>ç»Ÿè®¡ä¸æ•°æ®</h2></div>
      <div class="inner">
        <div class="kpi">
          <div class="item"><div class="muted">è®°å½•å‘¨æœŸæ•°</div><b id="kCycles">0</b></div>
          <div class="item"><div class="muted">å¹³å‡å‘¨æœŸ</div><b id="kAvg">â€”</b></div>
          <div class="item"><div class="muted">ä¸‹æ¬¡æœˆç»</div><b id="kNext">â€”</b></div>
          <div class="item"><div class="muted">æ˜“å­•æœŸ</div><b id="kFertile">â€”</b></div>
        </div>
        <div style="margin-top:6px">
          <button id="btnExport" class="ghost min">å¯¼å‡º</button>
          <input type="file" id="fileImport" accept="application/json" style="display:none"/>
          <button id="btnImport" class="ghost min">å¯¼å…¥</button>
          <button id="btnResetSamples" class="ghost min">æ¢å¤ç¤ºä¾‹</button>
          <button id="btnClearAll" class="ghost min">æ¸…ç©º</button>
        </div>
      </div>
    </section>
    <!-- å³ä¾§ï¼šæ—¥å† + å†å² -->
    <section class="card cal">
      <div class="section-head"><h2 id="calTitle">æ—¥å†</h2>
        <div><button id="prevM" class="ghost min">ä¸Šæœˆ</button><button id="todayM" class="ghost min">ä»Šå¤©</button><button id="nextM" class="ghost min">ä¸‹æœˆ</button></div>
      </div>
      <div class="inner">
        <div class="cal-grid" id="dow"></div>
        <div class="cal-grid" id="cal"></div>
        <div class="legend muted" id="legendToggle">
          <span class="tag" data-type="M" style="background:#f28b82;color:#fff;">ç»</span>
          <span class="tag" data-type="F" style="background:#81c995;color:#fff;">å­•</span>
          <span class="tag" data-type="O" style="background:#a1cfff;color:#fff;">æ’</span>
          <span class="tag" data-type="L" style="background:#fbc34a;color:#fff;">é»„</span>
          <span class="tag" data-type="SX">ğŸ’—</span>
          <span class="tag" data-type="BN">â„¹ï¸</span>
        </div>
      </div>
      <div class="section-head"><h2>å†å²ä¸ç¼–è¾‘</h2></div>
      <div class="inner">
        <input id="search" placeholder="æœç´¢å¤‡æ³¨æˆ–æ—¥æœŸ">
        <h3>å§¨å¦ˆå†å²</h3>
        <table id="tblPeriod"><thead><tr><th>å¼€å§‹</th><th>ç»“æŸ</th><th>ç»æœŸ</th><th>å‘¨æœŸ</th><th class="actions">æ“ä½œ</th></tr></thead><tbody></tbody></table>
        <button id="togglePeriod" class="ghost min">å±•å¼€æ›´å¤š</button>
        <h3>èº«ä½“å˜åŒ–</h3>
        <table id="tblBody"><thead><tr><th>æ—¥æœŸ</th><th>å¤‡æ³¨</th><th class="actions">æ“ä½œ</th></tr></thead><tbody></tbody></table>
        <button id="toggleBody" class="ghost min">å±•å¼€æ›´å¤š</button>
        <h3>å…³ç³»å†å²</h3>
        <table id="tblSex"><thead><tr><th>æ—¥æœŸ</th><th class="actions">æ“ä½œ</th></tr></thead><tbody></tbody></table>
        <button id="toggleSex" class="ghost min">å±•å¼€æ›´å¤š</button>
      </div>
    </section>
  </div>
</div>
<div id="toast" class="toast"></div>
<script>
/* ===== æ•°æ®å­˜å‚¨ ===== */
let periods=JSON.parse(localStorage.getItem("period")||"[]");
let bodies=JSON.parse(localStorage.getItem("body")||"[]");
let sexes=JSON.parse(localStorage.getItem("sex")||"[]");
function saveData(){localStorage.setItem("period",JSON.stringify(periods));localStorage.setItem("body",JSON.stringify(bodies));localStorage.setItem("sex",JSON.stringify(sexes));}
function toast(m){let t=document.getElementById("toast");t.textContent=m;t.style.display="block";clearTimeout(t._h);t._h=setTimeout(()=>t.style.display="none",1500);}
const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const parse=s=>{let [y,m,d]=s.split("-").map(Number);return new Date(y,m-1,d,12);};
const add=(d,n)=>{let x=new Date(d);x.setDate(x.getDate()+n);return x;}
const daysBetween=(a,b)=>Math.round((parse(b)-parse(a))/86400000);
const safe=s=>(s||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");

/* ===== KPIä¸é¢„æµ‹ ===== */
function getCycleLens(){let arr=[...periods].sort((a,b)=>a.start.localeCompare(b.start)),res=[];for(let i=1;i<arr.length;i++)res.push(daysBetween(arr[i-1].start,arr[i].start));return res;}
function avg(a){return a.length?Math.round(a.reduce((x,y)=>x+y)/a.length):null;}
function getAvgC(){return avg(getCycleLens())}
function getPred(){let last=[...periods].sort((a,b)=>a.start.localeCompare(b.start)).at(-1);if(!last)return{windows:[]};let avgC=getAvgC()||28;let pLen=last.len||5;let next=add(parse(last.start),avgC);let ovu=add(next,-14);let wins=[{from:parse(last.start),to:parse(last.end),type:"ç»"}];wins.push({from:add(ovu,-5),to:add(ovu,1),type:"å­•"});wins.push({from:ovu,to:ovu,type:"æ’"});wins.push({from:add(ovu,2),to:add(next,-1),type:"é»„"});return{next,windows:wins};}
function renderKPIs(){let cyc=getCycleLens();document.getElementById("kCycles").textContent=cyc.length;document.getElementById("kAvg").textContent=getAvgC()?getAvgC()+"å¤©":"â€”";let pred=getPred();document.getElementById("kNext").textContent=pred.next?fmt(pred.next):"â€”";}

/* ===== æ—¥å†æ¸²æŸ“ ===== */
let visibleFlags={M:true,F:true,O:true,L:true,SX:true,BN:true};
function ensureDow(){let el=document.getElementById("dow");if(el.dataset.ok)return;["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"].forEach(d=>{let x=document.createElement("div");x.textContent=d;x.className="muted";x.style.textAlign="center";el.appendChild(x)});el.dataset.ok=1;}
function renderCalendar(){
  ensureDow();
  let cal=document.getElementById("cal");cal.innerHTML="";
  let view=window.__viewDate||new Date(),cur=new Date(view);cur.setDate(1);
  let y=cur.getFullYear(),m=cur.getMonth();
  document.getElementById("calTitle").textContent=y+"å¹´"+(m+1)+"æœˆ";
  let start=(cur.getDay()+6)%7,days=new Date(y,m+1,0).getDate();
  let today=fmt(new Date());
  let pred=getPred().windows;
  let bodyMap=new Map();bodies.forEach(b=>bodyMap.set(b.date,(bodyMap.get(b.date)||0)+1));
  let sexSet=new Set(sexes.map(s=>s.date));
  for(let i=0;i<start;i++)cal.appendChild(document.createElement("div"));
  for(let d=1;d<=days;d++){
    let cell=document.createElement("div");cell.className="cell";
    let dd=new Date(y,m,d,12),ds=fmt(dd);
    if(ds===today)cell.classList.add("today");
    let num=document.createElement("div");num.className="d";num.textContent=d;cell.appendChild(num);
    // å†å²å‘¨æœŸ
    periods.forEach(p=>{
      if(parse(ds)>=parse(p.start)&&parse(ds)<=parse(p.end)){
        if(visibleFlags.M)cell.innerHTML+="<div style='font-size:10px;background:#f28b82;color:#fff;padding:1px 3px;border-radius:4px;display:inline-block'>ç»</div>";
      }
    });
    // é¢„æµ‹
    let flags=pred.filter(w=>dd>=w.from&&dd<=w.to).map(w=>w.type);
    if(visibleFlags.F&&flags.includes("å­•"))cell.innerHTML+="<div style='font-size:10px;background:#81c995;color:#fff;padding:1px 3px;border-radius:4px;display:inline-block'>å­•</div>";
    if(visibleFlags.O&&flags.includes("æ’"))cell.innerHTML+="<div style='font-size:10px;background:#a1cfff;color:#fff;padding:1px 3px;border-radius:4px;display:inline-block'>æ’</div>";
    if(visibleFlags.L&&flags.includes("é»„"))cell.innerHTML+="<div style='font-size:10px;background:#fbc34a;color:#fff;padding:1px 3px;border-radius:4px;display:inline-block'>é»„</div>";
    // å…³ç³»/å˜åŒ–
    let badges=document.createElement("div");badges.className="badges";
    if(visibleFlags.SX&&sexSet.has(ds))badges.innerHTML+="<span>ğŸ’—</span>";
    if(visibleFlags.BN&&bodyMap.has(ds))badges.innerHTML+="<span>â„¹ï¸</span>";
    if(badges.innerHTML)cell.appendChild(badges);
    cal.appendChild(cell);
  }
}

/* ===== å†å²è¡¨æ ¼ + å±•å¼€ ===== */
let showAll={period:false,body:false,sex:false};
function renderTables(f=''){f=f.trim().toLowerCase();
  let pBody=document.querySelector("#tblPeriod tbody");pBody.innerHTML="";
  periods.forEach((p,i)=>{if(f&&!(p.start.includes(f)||p.end.includes(f)))return;
    if(!showAll.period&&i<3||showAll.period){
      let cyc=i>0?daysBetween(periods[i-1].start,p.start):"â€”";
      pBody.innerHTML+=`<tr><td>${p.start}</td><td>${p.end}</td><td>${p.len}å¤©</td><td>${cyc}</td><td class="actions"><button data-act="editP" data-i="${i}">ç¼–è¾‘</button><button data-act="delP" data-i="${i}" class="ghost">åˆ é™¤</button></td></tr>`;
    }
  });
  document.getElementById("togglePeriod").style.display=periods.length>3?"block":"none";
  document.getElementById("togglePeriod").textContent=showAll.period?"æ”¶èµ·":"å±•å¼€æ›´å¤š";
  if(!pBody.innerHTML)pBody.innerHTML='<tr><td colspan=5 class=muted>æ— </td></tr>';
  let bBody=document.querySelector("#tblBody tbody");bBody.innerHTML="";
  bodies.forEach((b,i)=>{if(f&&!(b.date.includes(f)||(b.note||'').toLowerCase().includes(f)))return;
    if(!showAll.body&&i<3||showAll.body){
      bBody.innerHTML+=`<tr><td>${b.date}</td><td>${safe(b.note)}</td><td class="actions"><button data-act="editB" data-i="${i}">ç¼–è¾‘</button><button data-act="delB" data-i="${i}" class="ghost">åˆ é™¤</button></td></tr>`;
    }
  });
  document.getElementById("toggleBody").style.display=bodies.length>3?"block":"none";
  document.getElementById("toggleBody").textContent=showAll.body?"æ”¶èµ·":"å±•å¼€æ›´å¤š";
  if(!bBody.innerHTML)bBody.innerHTML='<tr><td colspan=3 class=muted>æ— </td></tr>';
  let sBody=document.querySelector("#tblSex tbody");sBody.innerHTML="";
  sexes.forEach((s,i)=>{if(f&&!s.date.includes(f))return;
    if(!showAll.sex&&i<3||showAll.sex){
      sBody.innerHTML+=`<tr><td>${s.date}</td><td class="actions"><button data-act="delS" data-i="${i}" class="ghost">åˆ é™¤</button></td></tr>`;
    }
  });
  document.getElementById("toggleSex").style.display=sexes.length>3?"block":"none";
  document.getElementById("toggleSex").textContent=showAll.sex?"æ”¶èµ·":"å±•å¼€æ›´å¤š";
  if(!sBody.innerHTML)sBody.innerHTML='<tr><td colspan=2 class=muted>æ— </td></tr>';
}
document.getElementById("togglePeriod").onclick=()=>{showAll.period=!showAll.period;renderTables();}
document.getElementById("toggleBody").onclick=()=>{showAll.body=!showAll.body;renderTables();}
document.getElementById("toggleSex").onclick=()=>{showAll.sex=!showAll.sex;renderTables();}

/* ===== ç‚¹å‡»æ“ä½œ ===== */
document.addEventListener("click",(e)=>{let btn=e.target.closest("button[data-act]");if(!btn)return;let act=btn.dataset.act,i=+btn.dataset.i;
  if(act==="delP"){if(confirm("åˆ é™¤å§¨å¦ˆï¼Ÿ")){periods.splice(i,1);saveData();renderAll();}}
  if(act==="editP"){let ns=prompt("æ–°å¼€å§‹",periods[i].start);if(!ns)return;let ne=prompt("æ–°ç»“æŸ",periods[i].end);if(!ne)return;periods[i]={start:ns,end:ne,len:daysBetween(ns,ne)+1};saveData();renderAll();}
  if(act==="delB"){if(confirm("åˆ é™¤å˜åŒ–ï¼Ÿ")){bodies.splice(i,1);saveData();renderAll();}}
  if(act==="editB"){let nd=prompt("æ—¥æœŸ",bodies[i].date);if(!nd)return;let nn=prompt("å¤‡æ³¨",bodies[i].note);if(nn===null)return;bodies[i]={date:nd,note:nn};saveData();renderAll();}
  if(act==="delS"){if(confirm("åˆ é™¤å…³ç³»ï¼Ÿ")){sexes.splice(i,1);saveData();renderAll();}}
},{passive:true});

/* ===== æ·»åŠ åŠŸèƒ½ ===== */
btnAddPeriod.onclick=()=>{let s=pStart.value,e=pEnd.value;if(!s||!e)return alert("è¯·å¡«å†™");if(parse(e)<parse(s))return alert("ç»“æŸä¸èƒ½æ—©äºå¼€å§‹");periods.push({start:s,end:e,len:daysBetween(s,e)+1});saveData();renderAll();};
btnQuickPeriod.onclick=()=>{let t=fmt(new Date());periods.push({start:t,end:t,len:1});saveData();renderAll();};
btnAddBody.onclick=()=>{let d=bDate.value,n=bNote.value;if(!d||!n)return alert("è¯·å®Œæ•´");bodies.push({date:d,note:n});saveData();renderAll();};
btnAddSex.onclick=()=>{let d=sDate.value;if(!d)return alert("è¯·é€‰æ‹©");sexes.push({date:d});saveData();renderAll();};

/* ===== å¯¼å…¥å¯¼å‡ºæ¸…ç©º ===== */
btnImport.onclick=()=>fileImport.click();
fileImport.addEventListener("change",(e)=>{let f=e.target.files[0];if(!f)return;let r=new FileReader();r.onload=()=>{try{let obj=JSON.parse(r.result);if(obj.period)periods=obj.period;if(obj.body)bodies=obj.body;if(obj.sex)sexes=obj.sex;saveData();renderAll();toast("å¯¼å…¥æˆåŠŸ");}catch(err){alert("å¯¼å…¥å¤±è´¥");}};r.readAsText(f);});
btnExport.onclick=()=>{let blob=new Blob([JSON.stringify({period:periods,body:bodies,sex:sexes},null,2)],{type:"application/json"});let a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="tracker.json";a.click();toast("å·²å¯¼å‡º");};
btnResetSamples.onclick=()=>{periods=[{start:"2025-07-05",end:"2025-07-09",len:5},{start:"2025-08-03",end:"2025-08-07",len:5},{start:"2025-09-01",end:"2025-09-05",len:5}];bodies=[{date:"2025-09-03",note:"æƒ…ç»ªä½è½"},{date:"2025-09-10",note:"çš®è‚¤å‡ºæ²¹"},{date:"2025-09-18",note:"ä¹³æˆ¿èƒ€ç—›"}];sexes=[{date:"2025-09-10"},{date:"2025-09-18"}];saveData();renderAll();};
btnClearAll.onclick=()=>{if(confirm("æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ")){periods=[];bodies=[];sexes=[];saveData();renderAll();}};

/* ===== æœç´¢è¿‡æ»¤ ===== */
search.addEventListener("keydown",(e)=>{if(e.key==="Enter")renderTables(e.target.value);});

/* ===== æœˆä»½åˆ‡æ¢ ===== */
window.__viewDate=new Date();
["prevM","nextM","todayM"].forEach(id=>{document.getElementById(id).onclick=()=>{if(id==="prevM")window.__viewDate.setMonth(window.__viewDate.getMonth()-1);if(id==="nextM")window.__viewDate.setMonth(window.__viewDate.getMonth()+1);if(id==="todayM")window.__viewDate=new Date();renderCalendar();}});

/* ===== å›¾ä¾‹åˆ‡æ¢ ===== */
document.getElementById("legendToggle").addEventListener("click",(e)=>{let tag=e.target.closest(".tag");if(!tag)return;let type=tag.dataset.type;if(!type)return;visibleFlags[type]=!visibleFlags[type];tag.style.opacity=visibleFlags[type]?"1":"0.3";renderCalendar();});

/* ===== æ¸²æŸ“èšåˆ ===== */
function renderAll(f=''){renderKPIs();renderCalendar();renderTables(f);}
renderAll();
</script>
</body>
</html>
