<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>周期日历｜莫兰迪版</title>
<style>
  :root{
    --bg:#f5f6f7; --card:#fff; --muted:#6b7a8a; --text:#222;
    --accent:#8ea7c2; --accent2:#b0c7a8;
    --danger:#d88c8c; --ok:#21c98a;
    --border:#e0e0e0; --shadow:0 6px 20px rgba(0,0,0,.08);
  }
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);margin-bottom:16px}
  .section-head{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;font-weight:700;border-bottom:1px solid var(--border)}
  .inner{padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  label{font-size:13px;font-weight:600}
  input,textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:13px}
  button{cursor:pointer;padding:8px 12px;border-radius:8px;border:1px solid var(--accent);background:var(--accent);color:#fff;font-weight:600;font-size:13px}
  button.ghost{background:transparent;color:var(--accent)}

  /* 日历 */
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:8px}
  .cell{border:1px solid var(--border);border-radius:8px;aspect-ratio:1/1;padding:4px;font-size:11px;position:relative;overflow:hidden;display:flex;flex-direction:column}
  .cell.today{border:2px solid var(--accent)}
  .cell .d{font-weight:700;margin-bottom:2px}
  .tags{display:flex;flex-direction:column;gap:2px;font-size:10px;line-height:1.2}
  .tag{border-radius:4px;padding:0 2px;white-space:nowrap}

  /* 状态颜色（莫兰迪风） */
  .tag.m {background:#d88c8c20;color:#d88c8c}
  .tag.f {background:#b0c7a820;color:#556b2f}
  .tag.o {background:#e6cfa820;color:#a67c00}
  .tag.l {background:#c3a6b120;color:#734d5c}
  .tag.sx{color:#b98ca0;font-size:12px}
  .tag.bn{color:#a8b9c7;font-size:12px;cursor:pointer;text-decoration:underline}

  /* 弹窗 */
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:999}
  .modal-content{background:#fff;padding:20px;border-radius:12px;max-width:300px;font-size:13px;line-height:1.5}
</style>
</head>
<body>
<div class="wrap">

  <!-- 记录中心 -->
  <section class="card">
    <div class="section-head">记录中心</div>
    <div class="inner">
      <div class="row">
        <div><label>开始</label><input id="pStart" type="date"></div>
        <div><label>结束</label><input id="pEnd" type="date"></div>
      </div>
      <div class="row">
        <button id="btnAddPeriod">添加姨妈记录</button>
        <button class="ghost" id="btnQuickPeriod">只点今天</button>
      </div>
      <div class="row">
        <div><label>日期</label><input id="bDate" type="date"></div>
        <textarea id="bNote" placeholder="身体变化备注"></textarea>
        <button id="btnAddBody">添加身体变化</button>
      </div>
      <div class="row">
        <div><label>日期</label><input id="sDate" type="date"></div>
        <button id="btnAddSex">添加关系日期</button>
      </div>
    </div>
  </section>

  <!-- 统计 -->
  <section class="card">
    <div class="section-head">统计与数据</div>
    <div class="inner">
      <div>记录周期数：<b id="kCycles">0</b></div>
      <div>平均周期：<b id="kAvg">—</b></div>
      <div>下次月经预计：<b id="kNext">—</b></div>
      <div>易孕窗口：<b id="kFertile">—</b></div>
      <div class="row">
        <button class="ghost" id="btnExport">导出</button>
        <button class="ghost" id="btnImport">导入</button>
        <button class="ghost" id="btnResetSamples">恢复示例</button>
        <button class="ghost" id="btnClearAll">清空</button>
      </div>
    </div>
  </section>

  <!-- 日历 -->
  <section class="card">
    <div class="section-head">日历</div>
    <div class="inner">
      <div class="cal-grid" id="dow"></div>
      <div class="cal-grid" id="cal"></div>
    </div>
  </section>
</div>

<!-- 弹窗 -->
<div id="modal" class="modal"><div class="modal-content" id="modalContent"></div></div>

<script>
const KEY_PERIOD='periodData_v2',KEY_BODY='bodyNotes_v2',KEY_SEX='sexData_v2';
const fmtLocal=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const parse=s=>{const [y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d,12,0,0,0)};
const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x};
const daysBetween=(a,b)=>Math.round((parse(b)-parse(a))/86400000);

function getPeriod(){return JSON.parse(localStorage.getItem(KEY_PERIOD)||'[]')}
function setPeriod(v){localStorage.setItem(KEY_PERIOD,JSON.stringify(v))}
function getBody(){return JSON.parse(localStorage.getItem(KEY_BODY)||'[]')}
function setBody(v){localStorage.setItem(KEY_BODY,JSON.stringify(v))}
function getSex(){return JSON.parse(localStorage.getItem(KEY_SEX)||'[]')}
function setSex(v){localStorage.setItem(KEY_SEX,JSON.stringify(v))}

// 示例数据
const SAMPLE={period:[{start:'2025-08-03',end:'2025-08-07',periodLen:5},{start:'2025-09-01',end:'2025-09-05',periodLen:5}],body:[{date:'2025-09-03',note:'轻微腹痛，情绪低落'},{date:'2025-09-10',note:'皮肤出油，长痘'}],sex:['2025-09-10']};
if(!localStorage.getItem(KEY_PERIOD)&&!localStorage.getItem(KEY_BODY)){setPeriod(SAMPLE.period);setBody(SAMPLE.body);setSex(SAMPLE.sex)}

function getCycleLengths(){const arr=[...getPeriod()].sort((a,b)=>a.start.localeCompare(b.start));const res=[];for(let i=1;i<arr.length;i++){res.push(daysBetween(arr[i-1].start,arr[i].start))}return res}
function avg(arr){return arr.length?Math.round(arr.reduce((a,b)=>a+b,0)/arr.length):null}
function getAvgCycle(){return avg(getCycleLengths())}
function getLastPeriod(){const arr=[...getPeriod()].sort((a,b)=>a.start.localeCompare(b.start));return arr.length?arr[arr.length-1]:null}
function getPredictions(){const last=getLastPeriod();if(!last)return{next:null,fertile:null,windows:[]};const avgC=getAvgCycle()||28;const pLen=last.periodLen||daysBetween(last.start,last.end)+1||5;const nextStart=addDays(parse(last.start),avgC);const ovu=addDays(nextStart,-14);const fertile=[addDays(ovu,-5),addDays(ovu,1)];const windows=[];const records=[...getPeriod().map(r=>({start:parse(r.start),end:parse(r.end),pLen:r.periodLen||5}))];records.push({start:parse(fmtLocal(nextStart)),end:addDays(parse(fmtLocal(nextStart)),pLen-1),pLen});for(let cur of records){windows.push({from:cur.start,to:cur.end,type:'m'});windows.push({from:addDays(cur.start,avgC-14-5),to:addDays(cur.start,avgC-14+1),type:'f'});windows.push({from:addDays(cur.start,avgC-14),to:addDays(cur.start,avgC-14),type:'o'});windows.push({from:addDays(cur.start,avgC-14+2),to:addDays(cur.start,avgC-1),type:'l'})}return{next:nextStart,fertile,windows}}

function renderCalendar(){const cal=document.getElementById('cal');cal.innerHTML='';const view=new Date();const cur=new Date(view.getFullYear(),view.getMonth(),1,12);const year=cur.getFullYear(),month=cur.getMonth();const startIdx=(cur.getDay()+6)%7;const daysInMonth=new Date(year,month+1,0).getDate();const today=fmtLocal(new Date());const {windows}=getPredictions();const bodyMap=new Map();getBody().forEach(it=>{bodyMap.set(it.date,(bodyMap.get(it.date)||[]).concat(it.note))});const sexSet=new Set(getSex());
for(let i=0;i<startIdx;i++){cal.appendChild(document.createElement('div'))}
for(let d=1;d<=daysInMonth;d++){const cell=document.createElement('div');cell.className='cell';const dd=new Date(year,month,d,12);const dstr=fmtLocal(dd);if(dstr===today)cell.classList.add('today');const num=document.createElement('div');num.className='d';num.textContent=d;cell.appendChild(num);const tags=document.createElement('div');tags.className='tags';for(const w of windows){if(dd>=w.from&&dd<=w.to){let name='';let cls='';if(w.type==='m'){name='月经期';cls='m'}if(w.type==='f'){name='易孕期';cls='f'}if(w.type==='o'){name='排卵日';cls='o'}if(w.type==='l'){name='黄体期';cls='l'}const span=document.createElement('span');span.className='tag '+cls;span.textContent=name;tags.appendChild(span)}}if(sexSet.has(dstr)){const span=document.createElement('span');span.className='tag sx';span.textContent='💗';tags.appendChild(span)}if(bodyMap.has(dstr)){const span=document.createElement('span');span.className='tag bn';span.textContent='ℹ️';span.onclick=()=>showModal(dstr,bodyMap.get(dstr));tags.appendChild(span)}cell.appendChild(tags);cal.appendChild(cell)}}

function renderKPIs(){document.getElementById('kCycles').textContent=getCycleLengths().length;document.getElementById('kAvg').textContent=getAvgCycle()?(getAvgCycle()+'天'):'—';const p=getPredictions();document.getElementById('kNext').textContent=p.next?fmtLocal(p.next):'—';document.getElementById('kFertile').textContent=p.fertile?`${fmtLocal(p.fertile[0])} ~ ${fmtLocal(p.fertile[1])}`:'—'}

function renderAll(){renderCalendar();renderKPIs()}

// 弹窗
function showModal(date,notes){const m=document.getElementById('modal');const mc=document.getElementById('modalContent');mc.innerHTML=`<b>${date}</b><ul>`+notes.map(n=>`<li>${n}</li>`).join('')+`</ul>`;m.style.display='flex'}
document.getElementById('modal').onclick=()=>{document.getElementById('modal').style.display='none'}

// 添加数据
document.getElementById('btnAddPeriod').onclick=()=>{const s=document.getElementById('pStart').value,e=document.getElementById('pEnd').value;if(!s||!e)return alert('请填写');if(parse(e)<parse(s))return alert('结束不能早于开始');const arr=getPeriod();arr.push({start:s,end:e,periodLen:daysBetween(s,e)+1});setPeriod(arr);renderAll()};
document.getElementById('btnQuickPeriod').onclick=()=>{const t=fmtLocal(new Date());const arr=getPeriod();arr.push({start:t,end:t,periodLen:1});setPeriod(arr);renderAll()};
document.getElementById('btnAddBody').onclick=()=>{const d=document.getElementById('bDate').value,n=document.getElementById('bNote').value.trim();if(!d||!n)return alert('请填写');const arr=getBody();arr.push({date:d,note:n});setBody(arr);renderAll()};
document.getElementById('btnAddSex').onclick=()=>{const d=document.getElementById('sDate').value;if(!d)return alert('请选择日期');const s=new Set(getSex());s.add(d);setSex([...s]);renderAll()};

// 导入导出
document.getElementById('btnExport').onclick=()=>{const obj={period:getPeriod(),body:getBody(),sex:getSex()};const blob=new Blob([JSON.stringify(obj)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='tracker.json';a.click()};
document.getElementById('btnImport').onclick=()=>{const i=document.createElement('input');i.type='file';i.accept='application/json';i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const data=JSON.parse(r.result);if(data.period)setPeriod(data.period);if(data.body)setBody(data.body);if(data.sex)setSex(data.sex);renderAll()}catch(err){alert('导入失败')}};r.readAsText(f)};i.click()};
document.getElementById('btnResetSamples').onclick=()=>{setPeriod(SAMPLE.period);setBody(SAMPLE.body);setSex(SAMPLE.sex);renderAll()};
document.getElementById('btnClearAll').onclick=()=>{if(confirm('清空全部?')){localStorage.clear();renderAll()}};

// 渲染
renderAll();
</script>
</body>
</html>
